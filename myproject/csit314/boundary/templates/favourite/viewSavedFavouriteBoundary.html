{% extends "base.html" %}
{% block content %}

<div>
    <table class="table">
        <thead>
        <tr>
            <th>Subject</th>
            <th>Date</th>
            <th>Action</th>
        </tr>
        </thead>
        <tbody id="favourite-table-body">
        </tbody>
    </table>
</div>

<script>
    fetch('/api/shortlisted')
        .then(response => response.json())
        .then(data => {
            const tableBody = document.getElementById('favourite-table-body');
            data.forEach(favourite => {
                const row = document.createElement('tr');
                row.id = `row-${favourite.id}`;

                const subjectCell = document.createElement('td');
                const subjectLink = document.createElement('a');
                subjectLink.href = `/viewPropertyListing/detail/${favourite.id}`;
                subjectLink.textContent = favourite.subject;
                subjectCell.appendChild(subjectLink);

                const dateCell = document.createElement('td');
                dateCell.textContent = favourite.create_date;

                const actionCell = document.createElement('td');
                const favouriteButton = document.createElement('button');
                favouriteButton.onclick = () => toggleFavourite(this, favourite.id);
                favouriteButton.className = 'favourite-btn';
                favouriteButton.id = `favourite-btn-${favourite.id}`;
                favouriteButton.textContent = 'X';
                actionCell.appendChild(favouriteButton);

                row.appendChild(subjectCell);
                row.appendChild(dateCell);
                row.appendChild(actionCell);
                tableBody.appendChild(row);
            });
        })
        .catch(error => {
            console.error('Error fetching favourite listings:', error);
        });

    function toggleFavourite(btn, propertyListingId) {
        fetch(`/toggle_favourite/${propertyListingId}`, {
            method: 'POST',
        })
        .then(response => response.json())
        .then(data => {
            if(data.success) {
                // If successfully removed from favourites, remove the corresponding listing from the page
                var row = document.getElementById(`row-${propertyListingId}`);
                row.parentNode.removeChild(row);
                if (document.querySelectorAll('#favourite-table-body tr').length === 0) {
                    const noDataRow = document.createElement('tr');
                    const noDataCell = document.createElement('td');
                    noDataCell.colSpan = 3;
                    noDataCell.textContent = 'There is no shortlisted property listing.';
                    noDataCell.style.textAlign = 'center';
                    noDataRow.appendChild(noDataCell);
                    document.getElementById('favourite-table-body').appendChild(noDataRow);
                }
            } else {
                // Display error message in case of fail
                console.error('Failed to remove favorite:', data.error);
            }
        })
        .catch((error) => {
            console.error('Error:', error);
        });
    }


</script>

<style>
.favourite-btn {
    padding: 5px 10px;
    border: 1px solid #ccc;
    background-color: #ff0000; /* Red background */
    color: white;
    cursor: pointer;
}
</style>

{% endblock %}
