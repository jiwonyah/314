{% extends "base.html" %}
{% block content %}


<div id="propList-container">
  <div id="propList-header">
    <h1 class="my-3 border-bottom pb-2" id="propList-title">Property Listings</h1>
    <!-- If the user is a buyer, show the button to view old property listings -->
    {% if g.user and g.user.role.value == "buyer" %}
    <div class="ordinal_btn" id="propList-viewOldBtnContainer">
      <a href="{{ url_for('viewOldPropertyListings.view_old_property_listings_index') }}" id="propList-viewOldBtn">
        View Old Property Listings >
      </a>
    </div>
    {% endif %}
  </div>
  <div class="search-container" id="propList-searchContainer">
    <input type="text" id="propList-searchInput" class="search-input" placeholder="Search by subject...">
    <button onclick="searchProperty()" class="search-button" id="propList-searchBtn">Search</button>
  </div>
  <div id="propList-table">
    <div id="propList-tbody">
      {% if propertyListing_table %}
      {% for propertyListing in propertyListing_table %}
      <div class="tr text-center" id="propList-row">
        <!-- Image -->
        <div class="td" id="propList-image">
          <img src="{{ propertyListing.image_url }}" alt="Property Image">
        </div>
        <!-- Subject -->
        <div class="td" id="propList-subject">
          <span onclick="window.location.href = '/propertyListing/detail/{{propertyListing.id}}'">
                    {{ propertyListing.subject }}
          </span>
        </div>
        <!-- Address -->
        <div class="td" id="propList-address">{{ propertyListing.address }}</div>
        <!-- Price -->
        <div class="td" id="propList-price">$ {{ propertyListing.price }}</div>
        <!-- Favourite Button -->
        {% if g.user and g.user.role.value == "buyer" %}
        <div class="td" id="propList-favBtnContainer">
          <button onclick="toggleFavourite(this, {{ propertyListing.id }})" class="favourite-btn" id="propList-favBtn">
            ♡
          </button>
        </div>
        {% endif %}
        <div class="divider"></div>
        <div class="info-container">
          <div class="td" id="propList-agent-{{ propertyListing.id }}">Listed by {{ propertyListing.agent.userid }}</div>
          {% if propertyListing.modify_date %}
          <div class="td" id="propList-modifyDate-{{ propertyListing.id }}">{{ propertyListing.modify_date.strftime('%Y-%m-%d') }}</div>
          {% else %}
          <div class="td" id="propList-createDate-{{ propertyListing.id }}">{{ propertyListing.create_date.strftime('%Y-%m-%d') }}</div>
          {% endif %}
        </div>
      </div>
      {% endfor %}
      {% else %}
      <div class="tr" id="propList-noContentRow">
        <div class="td" colspan="3" id="propList-noContent">No contents</div>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- Contact Agent Modal -->
<div id="contactAgentModal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <h3>Contact Information</h3>
    <p>Phone Number: +65 8888 8888</p>
    <p>Email: test@test.com</p>
  </div>
</div>

<!-- Button for posting new property listing -->
{% if g.user and g.user.role == "agent" %}
<div style="text-align: right; margin-top: 20px;" class="ordinal_btn">
    <button onclick="window.location.href = '/propertyListing/create/'" >Create New Property Listing</button>
</div>
{% endif %}
{% endblock %}

{% block script %}
<script>
  function searchProperty() {
    var searchQuery = document.getElementById('searchInput').value.trim();
    fetch(`/search_property_listings/?query=${searchQuery}`)
          .then(response => response.json())
          .then(data => {
            displaySearchResults(data);
          })
          .catch(error => {
            console.error('Error searching properties:', error);
          });
  }
    function displaySearchResults(results) {
        var tbody = document.querySelector('tbody');
        tbody.innerHTML = ''; // initialize previous search

        if (results.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4">No matching properties found.</td></tr>';
        } else {
            results.forEach(property => {
                var row = `<tr>
                        <td><a href="/propertyListing/${property.id}">${property.subject}</a></td>
                        <td>${property.agent.userid}</td>
                        <td>${property.create_date}</td>
                        <td><button onclick="toggleFavourite(${property.id})">Favourite</button></td>
                    </tr>`;
                tbody.innerHTML += row;
            });
        }
    }

  function toggleFavourite(btn, propertyListingId) {
      fetch(`/toggle_favourite/${propertyListingId}`, {
          method: 'POST',
      })
      .then(response => response.json())
      .then(data => {
          if(data.success) {
              // Toggle the heart symbol based on the "isFavourite" status
              if(data.isFavourite) {
                  btn.classList.add("favourite-active");
                  btn.textContent = "♥"; // Filled heart symbol
              } else {
                  btn.classList.remove("favourite-active");
                  btn.textContent = "♡"; // Empty heart symbol
              }
          }
      })
      .catch((error) => {
          console.error('Error:', error);
      });
  }

</script>
<script>
    // Function to search property
    function searchProperty() {
        const input = document.getElementById("searchInput");
        const filter = input.value.toUpperCase();
        const table = document.querySelector("table");
        const tr = table.getElementsByTagName("tr");

        // Loop through all table rows, and hide those who don't match the search query
        for (let i = 0; i < tr.length; i++) {
            const td = tr[i].getElementsByTagName("td")[0]; // Column to search in

            if (td) {
                const txtValue = td.textContent || td.innerText;
                if (txtValue.toUpperCase().indexOf(filter) > -1) {
                    tr[i].style.display = "";
                } else {
                    tr[i].style.display = "none";
                }
            }
        }
    }
</script>
{% endblock %}





